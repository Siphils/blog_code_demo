var a=window;a.dplay={id:Date.now(),baseurl:null,list:null,title:null,haslrc:!1,lrc:[],lrcbox:null,player:new Audio,cfg:a.localStorage,i:null,iss:0,ct:0,s:{enabled:!0,canvas:null,ctx:null,cwidth:null,cheight:null,meterNum:null,meterWidth:10,gap:2,capHeight:2,capStyle:"#FF9999",capYPositionArray:[],gradient:null,analyser:null,support:!0,init:function(){if(a.AudioContext=a.AudioContext||a.webkitAudioContext,!a.AudioContext)return void(dplay.s.support=0);dplay.s.canvas=$("<canvas id='dplay-s'></canvas>").attr({width:$(a).width(),height:300}).appendTo("body")[0],dplay.s.cwidth=dplay.s.canvas.width,dplay.s.cheight=dplay.s.canvas.height-dplay.s.capHeight,dplay.s.meterNum=dplay.s.cwidth/(dplay.s.meterWidth+dplay.s.gap),dplay.s.ctx=dplay.s.canvas.getContext("2d");var l=new AudioContext;dplay.s.analyser=l.createAnalyser(),l.createMediaElementSource(dplay.player).connect(dplay.s.analyser),dplay.s.analyser.connect(l.destination),dplay.s.gradient=dplay.s.ctx.createLinearGradient(0,0,0,dplay.s.cheight),dplay.s.gradient.addColorStop(1,"#FF9999"),dplay.s.gradient.addColorStop(0,"#FFFFCC"),dplay.s.enabled=!dplay.paused,dplay.s.renderFrame(),$(a).on("resize",function(){dplay.s.resetParams($(a).width(),300)})},resetParams:function(a,l){dplay.s.cwidth=dplay.s.canvas.width=a,dplay.s.canvas.height=l,dplay.s.cheight=l-dplay.s.capHeight,dplay.s.meterNum=dplay.s.cwidth/(dplay.s.meterWidth+dplay.s.gap)},renderFrame:function(){var a,l,d,p;if(!dplay.s.enabled)return void dplay.s.ctx.clearRect(0,0,dplay.s.cwidth,dplay.s.cheight+dplay.s.capHeight);for(a=new Uint8Array(dplay.s.analyser.frequencyBinCount),dplay.s.analyser.getByteFrequencyData(a),l=Math.round(.65*a.length/dplay.s.meterNum),dplay.s.ctx.clearRect(0,0,dplay.s.cwidth,dplay.s.cheight),d=0;d<dplay.s.meterNum;d++)p=a[d*l]*dplay.s.cheight/300,dplay.s.capYPositionArray.length<Math.round(dplay.s.meterNum)&&dplay.s.capYPositionArray.push(p),dplay.s.ctx.fillStyle=dplay.s.capStyle,p<dplay.s.capYPositionArray[d]?dplay.s.ctx.fillRect(d*(dplay.s.meterWidth+dplay.s.gap),dplay.s.cheight- --dplay.s.capYPositionArray[d],dplay.s.meterWidth,dplay.s.capHeight):(dplay.s.ctx.fillRect(d*(dplay.s.meterWidth+dplay.s.gap),dplay.s.cheight-p,dplay.s.meterWidth,dplay.s.capHeight),dplay.s.capYPositionArray[d]=p),dplay.s.ctx.fillStyle=dplay.s.gradient,dplay.s.ctx.fillRect(d*(dplay.s.meterWidth+dplay.s.gap),dplay.s.cheight-p+dplay.s.capHeight,dplay.s.meterWidth,dplay.s.cheight);requestAnimationFrame(dplay.s.renderFrame)},enable:function(){dplay.s.enabled||(dplay.s.enabled=!0,dplay.s.support&&dplay.s.renderFrame())},disable:function(){dplay.s.enabled=!1}},play:function(a){dplay.cfg.dp_id=dplay.id,$("#dplay-play").removeClass("dp-play"),$("#dplay-name").html(dplay.list[a][1]),dplay.i!=a&&(dplay.lrc=null,dplay.i=a,dplay.player.src=dplay.baseurl+"dplay.php?id="+dplay.list[a][0]+"&t=mp3",dplay.loadlrc()),dplay.cfg.dp_i==a?dplay.player.currentTime=dplay.cfg.dp_ct:dplay.cfg.dp_i=a,dplay.cfg.dp_iss=0,dplay.player.play(),dplay.s.support&&1*dplay.cfg.dp_charging&&dplay.s.enable()},pause:function(){dplay.lrcbox.text(dplay.title),$("#dplay-play").addClass("dp-play"),dplay.player.pause(),dplay.s.support&&dplay.s.disable()},loadlrc:function(){dplay.lrc=[],dplay.haslrc=!1,dplay.lrcbox.text(dplay.title),$.get(dplay.baseurl+"dplay.php?id="+dplay.list[dplay.i][0]+"&t=lrc",function(a){a.lrc&&a.lrc.lyric.split("\n").forEach(function(a){var l=/\[(\d+):(\d+)\.(\d+)\](.+)/.exec(a);l&&(dplay.lrc[Math.floor(60*l[1]+1*l[2]+1*("0."+l[3]))]=l[4].trim(),dplay.haslrc=!0)})},"json")},init:function(l){$("script").each(function(){return this.src&&this.src.indexOf("dplay.js")>0?(dplay.baseurl=this.src.replace("dplay.js",""),!1):void 0}),$.get(dplay.baseurl+"dplay.json?_="+Date.now(),function(d){var p,i,t,e;return d.length?(dplay.lrcbox=$(l||"title"),dplay.title=dplay.lrcbox.text(),dplay.list=d,dplay.iss=dplay.cfg.dp_iss||0,dplay.cfg.dp_id=dplay.id,p='<div id="dplay" class="dpani"><i id="dplay-list" class="dpani dpico dp-list"><ul class="dpani">',$.each(dplay.list,function(a,l){p+='<li class="dpani"><i class="dpani dpico dp-logo"></i>'+l[1]+"</li>"}),p+='</ul></i><div id="dplay-name">darren\'s blog</div><i id="dplay-play" class="dpani dpico dp-play dp-pause" title="播放/暂停"></i><i id="dplay-next" class="dpani dpico dp-next" title="下一曲"></i><i id="dplay-logo" class="dpani dpico dp-logo" title="显示/隐藏播放器"></i><div id="dplay-bar-all" class="dpani"><div id="dplay-bar" class="dpani"></div></div></div>',i=$(p).appendTo("body").on("click","#dplay-logo",function(){$("#dplay").toggleClass("dpshow")}).on("click","li",function(){var a,l=$(this);l.hasClass("dpnow")&&!dplay.player.paused||(a=l.parent(),a.stop().animate({scrollTop:l.offset().top-a.offset().top+a.scrollTop()},"fast"),dplay.play(l.siblings(".dpnow").removeClass("dpnow").end().addClass("dpnow").index()))}).on("click","#dplay-play",function(){$(this).hasClass("dp-play")?i.find("li:eq("+(dplay.i||dplay.cfg.dp_i||0)+")").trigger("click"):(dplay.pause(),dplay.cfg.dp_iss=1)}).on("click","#dplay-next",function(){var a=1*(dplay.cfg.dp_i||0)+1;a=a>=dplay.list.length?0:a,$("#dplay-list li:eq("+a+")").trigger("click")}),t=0,$(dplay.player).on("timeupdate",function(){var a,l,d;dplay.id!=dplay.cfg.dp_id&&dplay.pause(),a=dplay.player.currentTime,dplay.cfg.dp_ct=a,$("#dplay-bar").width(100*a/dplay.player.duration+"%"),dplay.haslrc&&(l=Math.floor(a),t!=l&&(t=l,d=dplay.lrc[t],d&&dplay.lrcbox.text(d)))}).on("ended error",function(){$("#dplay-next").trigger("click")}),dplay.cfg.dp_charging=1,e=/Android|Phone|iPad|iPod/i.test(navigator.userAgent),!e&&dplay.s.init(),e||navigator.getBattery&&navigator.getBattery().then(function(a){a.charging?(dplay.cfg.dp_charging=1,dplay.s.support&&dplay.s.enable()):(dplay.cfg.dp_charging=0,dplay.s.disable()),a.onchargingchange=function(){this.charging?(dplay.cfg.dp_charging=1,dplay.s.support&&dplay.s.enable()):(dplay.cfg.dp_charging=0,dplay.s.disable())}}),void(!e&&0==dplay.iss&&i.find("li:eq("+(dplay.cfg.dp_i||0)+")").trigger("click"))):(a.dplay=null,!1)},"json")}},dplay.init("#logo+p");